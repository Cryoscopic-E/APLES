<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Activity Manager</h1>

        <!-- Add Activity Form -->
        <form action="{{ url_for('add_activity') }}" method="POST" class="mb-4" id="addActivityForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="Activities" class="form-label">Activity</label>
                    <input type="text" class="form-control" id="Activities" name="Activities" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="METScore" class="form-label">MET Score</label>
                    <input type="number" step="0.1" class="form-control" id="METScore" name="METScore" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="Type" class="form-label">Type</label>
                    <select class="form-select" id="Type" name="Type" required>
                        <option value="Physical">Physical</option>
                        <option value="Cognitive">Cognitive</option>
                        <option value="Social">Social</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="Frequency" class="form-label">Frequency</label>
                    <input type="text" class="form-control" id="Frequency" name="Frequency" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="CurrentCost" class="form-label">Current Cost</label>
                    <input type="number" step="0.01" class="form-control" id="CurrentCost" name="CurrentCost" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label for="CostIncrease" class="form-label">Cost Increase</label>
                    <input type="number" step="0.01" class="form-control" id="CostIncrease" name="CostIncrease"
                        required>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="Steps" class="form-label">Steps</label>
                    <input type="number" class="form-control" id="Steps" name="Steps" value="0">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="StepsAggregate" class="form-label">Steps Aggregate</label>
                    <input type="number" class="form-control" id="StepsAggregate" name="StepsAggregate" value="0">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Activity</button>
        </form>

        <!-- Activities Table -->
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>MET Score</th>
                    <th>Type</th>
                    <th>Frequency</th>
                    <th>Current Cost</th>
                    <th>Cost Increase</th>
                    <th>Steps</th>
                    <th>Steps Aggregate</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in activities %}
                <tr>
                    <td>{{ activity['Activities'] }}</td>
                    <td>{{ activity['METScore'] }}</td>
                    <td>{{ activity['Type'] }}</td>
                    <td>{{ activity['Frequency'] }}</td>
                    <td>{{ activity['CurrentCost'] }}</td>
                    <td>{{ activity['CostIncrease'] }}</td>
                    <td>{{ activity['Steps'] }}</td>
                    <td>{{ activity['StepsAggregate'] }}</td>
                    <td>
                        <!-- Trigger the update modal -->
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal"
                            data-bs-target="#updateModal" data-index="{{ loop.index0 }}"
                            data-activity="{{ activity['Activities'] }}" data-metscore="{{ activity['METScore'] }}"
                            data-type="{{ activity['Type'] }}" data-frequency="{{ activity['Frequency'] }}"
                            data-currentcost="{{ activity['CurrentCost'] }}"
                            data-costincrease="{{ activity['CostIncrease'] }}" data-steps="{{ activity['Steps'] }}"
                            data-stepsaggregate="{{ activity['StepsAggregate'] }}">
                            Update
                        </button>

                        <!-- Delete button -->
                        <form action="{{ url_for('delete_activity', index=loop.index0) }}" method="POST"
                            class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Combined Graph Section -->
        <div class="mb-4">
            <h3 class="mb-3">Combined Level Difficulty Graph</h3>
            <canvas id="combinedChart" width="400" height="200"></canvas>

            <div class="row mt-3">
                <div class="col-md-4">
                    <input type="number" id="levelInput" class="form-control" placeholder="Level Number" min="0"
                        required>
                </div>
                <div class="col-md-4">
                    <input type="number" id="difficultyInput" class="form-control" placeholder="Difficulty" min="0"
                        required>
                </div>
                <div class="col-md-4">
                    <select id="difficultyType" class="form-select" required>
                        <option value="Physical">Physical</option>
                        <option value="Cognitive">Cognitive</option>
                        <option value="Social">Social</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <button id="addPointBtn" class="btn btn-primary w-100">Add Point</button>
                </div>
            </div>
        </div>


        <!-- Create Level Button -->
        <form action="{{ url_for('create_level') }}" method="POST">
            <button id="generateLevelBtn" type="submit" class="btn btn-success">Create Level</button>
        </form>
    </div>

    <!-- Update Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Update Activity</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateForm" method="POST">
                        <input type="hidden" id="updateIndex">
                        <div class="mb-3">
                            <label for="updateActivities" class="form-label">Activity</label>
                            <input type="text" class="form-control" id="updateActivities" name="Activities" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateMETScore" class="form-label">MET Score</label>
                            <input type="number" step="0.1" class="form-control" id="updateMETScore" name="METScore"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="updateType" class="form-label">Type</label>
                            <select class="form-select" id="updateType" name="Type" required>
                                <option value="Physical">Physical</option>
                                <option value="Cognitive">Cognitive</option>
                                <option value="Social">Social</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="updateFrequency" class="form-label">Frequency</label>
                            <input type="text" class="form-control" id="updateFrequency" name="Frequency" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateCurrentCost" class="form-label">Current Cost</label>
                            <input type="number" step="0.01" class="form-control" id="updateCurrentCost"
                                name="CurrentCost" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateSteps" class="form-label">Steps</label>
                            <input type="number" class="form-control" id="updateSteps" name="Steps" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="updateStepsAggregate" class="form-label">Steps Aggregate</label>
                            <input type="number" class="form-control" id="updateStepsAggregate" name="StepsAggregate"
                                value="0">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Activity</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize the combined Chart.js instance
        const ctx = document.getElementById('combinedChart').getContext('2d');
        const combinedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Levels (x-axis)
                datasets: [
                    {
                        label: 'Physical Difficulty',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        label: 'Cognitive Difficulty',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        label: 'Social Difficulty',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Level Number'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Difficulty'
                        },
                        ticks: {
                            stepSize: 1
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            }
        });

        // Function to add data points to the combined chart
        document.getElementById('addPointBtn').addEventListener('click', function (event) {
            event.preventDefault();
            const level = parseInt(document.getElementById('levelInput').value);
            const difficulty = parseInt(document.getElementById('difficultyInput').value);
            const type = document.getElementById('difficultyType').value;

            if (!isNaN(level) && !isNaN(difficulty)) {
                let dataset;
                if (type === 'Physical') {
                    dataset = combinedChart.data.datasets[0];
                } else if (type === 'Cognitive') {
                    dataset = combinedChart.data.datasets[1];
                } else if (type === 'Social') {
                    dataset = combinedChart.data.datasets[2];
                }

                if (dataset) {
                    if (!combinedChart.data.labels.includes(level)) {
                        combinedChart.data.labels.push(level);
                    }
                    dataset.data.push({ x: level, y: difficulty });
                    combinedChart.update();
                }
            }
        });

        // Add Event Listener for Type Selection
        document.getElementById('Type').addEventListener('change', function () {
            handleTypeChange(this.value, 'Steps', 'StepsAggregate');
        });

        // Add Event Listener for Update Modal Type Selection
        document.getElementById('updateType').addEventListener('change', function () {
            handleTypeChange(this.value, 'updateSteps', 'updateStepsAggregate');
        });

        // Handle the Type Change to enforce the rules
        function handleTypeChange(type, stepsId, stepsAggregateId) {
            var stepsField = document.getElementById(stepsId);
            var stepsAggregateField = document.getElementById(stepsAggregateId);

            if (type === 'Physical') {
                stepsField.disabled = false;
                stepsAggregateField.disabled = false;
            } else {
                stepsField.disabled = true;
                stepsAggregateField.disabled = true;
                stepsField.value = '0';
                stepsAggregateField.value = '0';
            }

            if (type === 'Physical') {
                stepsField.addEventListener('input', function () {
                    if (this.value) {
                        stepsAggregateField.value = '0';
                    }
                });

                stepsAggregateField.addEventListener('input', function () {
                    if (this.value) {
                        stepsField.value = '0';
                    }
                });
            }
        }

        // Initialize Modal for Update
        var updateModal = document.getElementById('updateModal');
        updateModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var index = button.getAttribute('data-index');
            var activity = button.getAttribute('data-activity');
            var metscore = button.getAttribute('data-metscore');
            var type = button.getAttribute('data-type');
            var frequency = button.getAttribute('data-frequency');
            var currentcost = button.getAttribute('data-currentcost');
            var costincrease = button.getAttribute('data-costincrease');
            var steps = button.getAttribute('data-steps');
            var stepsaggregate = button.getAttribute('data-stepsaggregate');

            var updateForm = document.getElementById('updateForm');
            updateForm.action = '/update/' + index;

            document.getElementById('updateActivities').value = activity;
            document.getElementById('updateMETScore').value = metscore;
            document.getElementById('updateType').value = type;
            document.getElementById('updateFrequency').value = frequency;
            document.getElementById('updateCurrentCost').value = currentcost;
            document.getElementById('updateCostIncrease').value = costincrease;
            document.getElementById('updateSteps').value = steps;
            document.getElementById('updateStepsAggregate').value = stepsaggregate;

            // Trigger type change handling for the update modal
            handleTypeChange(type, 'updateSteps', 'updateStepsAggregate');
        });

        document.getElementById('Activities').addEventListener('input', function () {
            this.value = this.value.replace(/\s+/g, '_');
        });

        document.getElementById('updateActivities').addEventListener('input', function () {
            this.value = this.value.replace(/\s+/g, '_');
        });





        // Handle the Generate Level button click
        document.getElementById('generateLevelBtn').addEventListener('click', function (event) {


            // Function to gather all activities data
            function getActivitiesData() {
                const activities = [];
                document.querySelectorAll('tbody tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    activities.push({
                        Activities: cells[0].innerText,
                        METScore: cells[1].innerText,
                        Type: cells[2].innerText,
                        Frequency: cells[3].innerText,
                        CurrentCost: cells[4].innerText,
                        CostIncrease: cells[5].innerText,
                        Steps: cells[6].innerText,
                        StepsAggregate: cells[7].innerText
                    });
                });
                return activities;
            }

            // Function to gather graph data
            function getGraphData() {
                return {
                    labels: combinedChart.data.labels,
                    datasets: combinedChart.data.datasets.map(dataset => dataset.data)
                };
            }




            event.preventDefault();

            const activities = getActivitiesData();
            const graph = getGraphData();

            fetch('/create_level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ activities, graph })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('CSV files saved successfully!');
                    } else {
                        alert('Failed to save CSV files.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving CSV files.');
                });
        });
    </script>
</body>

</html>